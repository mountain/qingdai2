# 气候模拟框架：单层大气模型

为了模拟“青黛”的大气环流和地表环境，我们提出一个计算上高效、物理上抓住核心矛盾的简化GCM。

## 3.1 模型核心：单层正压动力学

我们将整个大气层简化为一层厚度均匀的流体，其运动由**浅水波方程组**在旋转球体上描述。该模型能有效模拟由科里奥利效应主导的大尺度环流，如行星波和急流，但无法模拟需要垂直结构才能产生的斜压不稳定性（即真实天气系统的主要成因）。这在我们的概念验证阶段是一个理想的平衡。

## 3.2 驱动力：动态辐射平衡温度 $T_{eq}$

模型的“引擎”是牛顿冷却方案，即大气会向一个理论的“辐射平衡温度场” $T_{eq}$ 弛豫。与地球不同，“青黛”的 $T_{eq}$ 场是动态的。

1.  **计算 $T_{eq}$**: 上一章计算出的总能量通量 $S_{total}(t)$ 是计算 $T_{eq}$ 的基础。我们需要进一步考虑行星自转、轴倾角，将这个总通量分配到全球每个格点 `(lat, lon)` 上，得到瞬时入射能量 $I(\text{lat, lon, t})$。然后根据斯特藩-玻尔兹曼定律，计算出该点的平衡温度：
    $$
    T_{eq}(\text{lat, lon, t}) = \left( \frac{I(\text{lat, lon, t}) \cdot (1 - \alpha)}{\sigma} \right)^{1/4}
    $$
2.  **驱动大气**: 这个时变的 $T_{eq}$ 场将作为大气模型的热力强迫项，驱动大气运动，形成风场和环流。

## 3.3 地表“水光热”条件参数化

基于上述动力核心和驱动力，我们可以进一步诊断出地表的水、光、热条件。

  - **热 (Heat)**:
    地表热量条件由大气环流对 $T_{eq}$ 场的响应直接决定。模型输出的（与厚度 `h` 相关的）温度场就是“热”的直接模拟。

  - **光 (Light)**:
    光照条件由天文学直接决定（双星位置、行星自转），是计算 $T_{eq}$ 的输入。此外，我们可以建立一个简单的云量参数化：**有降水的区域云量增加，削弱到达地表的光照**，从而实现光照与气候的初步反馈。

  - **水 (Water)**:
    由于模型没有湿度变量，我们设计一个**“动力-降水”诊断方案**。我们假设大规模降水发生在空气强烈辐合的区域。

    1.  **计算散度**: 在每个时间步，计算风场的水平散度场 $D$。
    2.  **诊断降水（平滑坡度）**: 用连续函数代替硬阈值，避免方块伪迹并增强与动力的一致性：
        $$
        P \;=\; k_{\mathrm{precip}}\;\max\!\bigl(0,\; D_{\mathrm{crit}} - D \bigr)
        $$
        - 默认不再使用“由云量门控降水”的硬阈值；主循环中对 `diagnose_precipitation` 关闭 `cloud_threshold`，避免因果倒置。
        - 可选地对 $P$ 做轻度高斯平滑去除像素级伪迹（代码默认 $\sigma\approx1$ 个格点）。

    3.  **由降水诊断云量（饱和型正相关）**：
        $$
        C \;=\; C_{\max}\,\tanh\!\left(\frac{P}{P_{\mathrm{ref}}}\right),\qquad C\in[0,1]
        $$
        - $C_{\max}$ 默认为 0.95（可用环境变量 `QD_CMAX` 调整）。
        - 参考尺度 $P_{\mathrm{ref}}$ 默认取“正降水像元的中位数”（可用环境变量 `QD_PREF` 指定，典型 $10^{-5}\!\sim\!10^{-4}$，视单位与场强）。
        - 对 $C$ 做轻度高斯平滑（$\sigma\approx1$）以避免块状边缘。

    4.  **额外的云源项（气候学启发）**（`parameterize_cloud_cover`）：
        - 基于地表温度的蒸发/凝结代理（tanh 连续函数，应用于全域，不再对海陆做硬掩膜）。
        - 相对涡度（$\,\zeta/f\,$）提升的抬升源项（平滑阈值）。
        - $\lvert \mathbf{V}\cdot\nabla T\rvert$ 作为锋生代理（平滑阈值）。
        - 三者相加后再做轻度平滑与截断到 $[0,1]$。

    5.  **云量融合（保留记忆 + 强耦合降水 + 背景源）**：
        $$
        C^{(n+1)} \;=\; w_{\mathrm{mem}}\,C^{(n)} \;+\; w_{P}\,C(P)\;+\; w_{\mathrm{src}}\;\mathrm{clip}\!\left(C^{(n)} + S_{\mathrm{cloud}}\frac{\Delta t}{6\,\mathrm{h}},\,0,\,1\right)
        $$
        - 权重默认 $(w_{\mathrm{mem}}, w_P, w_{\mathrm{src}})=(0.4,\,0.4,\,0.2)$，可用环境变量 `QD_W_MEM`、`QD_W_P`、`QD_W_SRC` 调整（自动归一化）。
        - 该融合使“强降水区 → 高云量”的直觉得到保证，同时保留云的时间记忆与背景生成。

    6.  **反照率耦合**：
        - 动态反照率采用
          $$
          \alpha \;=\; \alpha_{\mathrm{surface}}(T_s)\,(1-C) \;+\; \alpha_{\mathrm{cloud}}\,C,
          $$
          其中 $\alpha_{\mathrm{surface}}$ 随地表温度体现冰-反照率反馈；$C$ 来自上述融合云量。

## 3.4 数值稳定性与动力实现细节

- **赤道 $f$ 正则化**：保证 $|f|$ 不小于 $|\;2\Omega\sin(5^\circ)\;|$ 且保持符号，消除除零/病态放大（`pygcm/dynamics.py`）。
- **地转风钳制**：$|u_g|,|v_g| \le 200\,\mathrm{m\,s^{-1}}$ 防止数值爆裂。
- **地表温度半拉氏平流**：用半拉氏方案对 $T_s$ 做轻混合（权重≈0.2），增强热平流与非纬向性。
- **全局扩散**：温和扩散因子≈0.995（先前 0.95），兼顾稳定与结构保持。
- **云寿命**：经验性 2 天 e-folding（缓解过快消散）。
- **地表摩擦**：使用海陆差异摩擦图（`pygcm/topography.generate_base_properties`），陆地强、海洋弱。
- **运行控制（环境变量）**：
  - `QD_SIM_DAYS`（单位：行星日）、`QD_PLOT_EVERY_DAYS`（单位：行星日）、`QD_DT_SECONDS`（单位：秒）：积分时长 / 出图频率 / 步长。
  - `QD_CMAX`、`QD_PREF`：云-雨关系参数（$C_{\max}$、$P_{\mathrm{ref}}$）。
  - `QD_W_MEM`、`QD_W_P`、`QD_W_SRC`：云量融合权重。
